<!-- Enhanced Webflow Embed Code with Configuration Hot-Reloading -->
<!-- Copy this to Webflow Site Settings ‚Üí Custom Code ‚Üí Head -->
<script>
(function() {
  // Configuration URL for hot-reloading
  const configUrl = 'https://joaopdecarvalho.github.io/webflow-gunther-map/config/3d-config.json';
  
  // UNCOMMENT the next line to force PRODUCTION mode (test before going live!)
  // window.SCRIPT_BASE_URL = 'https://joaopdecarvalho.github.io/webflow-gunther-map/src';
  
  const isDev = location.hostname.includes('.webflow.io');
  const baseUrl = window.SCRIPT_BASE_URL || (isDev 
    ? 'http://localhost:8080/src' 
    : 'https://joaopdecarvalho.github.io/webflow-gunther-map/src');
  
  // Configuration versioning for cache-busting
  let currentConfigVersion = localStorage.getItem('3d-config-version') || '0';
  let configCheckInterval;
  
  // Check for configuration updates
  async function checkForConfigUpdates() {
    try {
      const response = await fetch(configUrl + '?v=' + Date.now(), {
        method: 'HEAD',
        cache: 'no-cache'
      });
      
      const lastModified = response.headers.get('Last-Modified') || response.headers.get('ETag');
      const storedVersion = localStorage.getItem('3d-config-last-modified');
      
      if (lastModified && lastModified !== storedVersion) {
        console.log('üîÑ New configuration detected, updating...');
        localStorage.setItem('3d-config-last-modified', lastModified);
        
        // Show update indicator
        showConfigUpdateIndicator();
        
        // Reload the 3D scene if it exists
        if (window.webflow3DScene && window.webflow3DScene.reload) {
          window.webflow3DScene.reload();
        }
      }
    } catch (error) {
      console.log('Configuration check failed (this is normal if offline):', error.message);
    }
  }
  
  // Show visual indicator when new configuration is available
  function showConfigUpdateIndicator() {
    // Remove existing indicator
    const existing = document.getElementById('webflow-3d-update-indicator');
    if (existing) existing.remove();
    
    // Create new indicator
    const indicator = document.createElement('div');
    indicator.id = 'webflow-3d-update-indicator';
    indicator.innerHTML = `
      <div style="
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        color: white;
        padding: 12px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        font-size: 14px;
        font-weight: 500;
        z-index: 10000;
        animation: slideInRight 0.3s ease-out;
        cursor: pointer;
        user-select: none;
      " onclick="this.parentElement.remove()">
        ‚ú® 3D Configuration Updated
        <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">
          Click to dismiss
        </div>
      </div>
      <style>
        @keyframes slideInRight {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
      </style>
    `;
    
    document.body.appendChild(indicator);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (document.getElementById('webflow-3d-update-indicator')) {
        indicator.style.animation = 'slideInRight 0.3s ease-out reverse';
        setTimeout(() => indicator.remove(), 300);
      }
    }, 5000);
  }
  
  // Initialize configuration monitoring
  function initConfigMonitoring() {
    // Check immediately
    checkForConfigUpdates();
    
    // Check every 30 seconds for updates
    configCheckInterval = setInterval(checkForConfigUpdates, 30000);
    
    // Clear interval when page is unloaded
    window.addEventListener('beforeunload', () => {
      if (configCheckInterval) {
        clearInterval(configCheckInterval);
      }
    });
  }
  
  // Scripts that load on EVERY page
  window.globalScripts = ['alert'];  // Add your global scripts here
  
  // Page-specific scripts and styles
  const isHomePage = window.location.pathname === '/' || window.location.pathname === '';
  if (isHomePage) {
    window.pageScripts = ['3d-map'];
    window.pageStyles = ['3d-map'];
    
    // Start configuration monitoring only on pages with 3D content
    setTimeout(initConfigMonitoring, 2000);
  }
  
  // Enhanced error handling for production
  window.addEventListener('error', (event) => {
    if (event.filename && event.filename.includes('webflow-gunther-map')) {
      console.warn('3D Map Script Error:', event.error?.message || event.message);
      
      // Show fallback message for critical errors
      if (event.error?.message?.includes('WebGL') || 
          event.error?.message?.includes('Three') ||
          event.error?.message?.includes('3d-map')) {
        
        const container = document.querySelector('#webgl-container') || 
                         document.querySelector('.w-webgl-container') ||
                         document.querySelector('[data-webgl-container]');
        
        if (container) {
          container.innerHTML = `
            <div style="
              display: flex;
              align-items: center;
              justify-content: center;
              min-height: 400px;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
              text-align: center;
              border-radius: 12px;
              padding: 40px 20px;
            ">
              <div>
                <div style="font-size: 48px; margin-bottom: 20px;">üèóÔ∏è</div>
                <div style="font-size: 24px; font-weight: 600; margin-bottom: 12px;">
                  3D Experience Loading...
                </div>
                <div style="font-size: 16px; opacity: 0.9;">
                  The interactive map will appear here shortly
                </div>
              </div>
            </div>
          `;
        }
      }
    }
  });
  
  // Load the router
  const script = document.createElement('script');
  script.src = baseUrl + '/router.js';
  script.onerror = function() {
    console.warn('Failed to load 3D map scripts. This is normal if the service is temporarily unavailable.');
  };
  document.head.appendChild(script);
})();
</script>